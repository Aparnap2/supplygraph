// SupplyGraph - Canonical Prisma Schema
// Multi-tenant with Row-Level Security (RLS)

generator client {
  provider = "prisma-client-py"
  output   = "./prisma_client"
  interface = "asyncio"
  recursive_type_depth = 5
  enable_experimental_decimal = true
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================================
// MULTI-TENANT CORE MODELS
// ================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logo      String?
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users    User[]
  vendors  Vendor[]
  requests ProcurementRequest[]
  quotes   Quote[]
  payments Payment[]
  auditLogs AuditLog[]

  @@map("organizations")
}

model User {
  id           String  @id @default(cuid())
  email        String  @unique
  name         String?
  avatar       String?
  role         UserRole @default(MEMBER)
  isActive     Boolean @default(true)
  
  // Multi-tenant
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  // Auth metadata (Better Auth will handle sessions)
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  createdRequests ProcurementRequest[]
  auditLogs      AuditLog[]

  @@map("users")
}

enum UserRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// ================================
// PROCUREMENT CORE MODELS
// ================================

model Vendor {
  id          String  @id @default(cuid())
  name        String
  email       String
  phone       String?
  website     String?
  address     Json?   // { street, city, state, zip, country }
  
  // Multi-tenant
  orgId       String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  // Vendor metadata
  metadata    Json?   // Custom fields, preferences, etc.
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  quotes      Quote[]

  @@map("vendors")
}

model ProcurementRequest {
  id          String            @id @default(cuid())
  title       String
  description String?
  items       Json              // [{ name, quantity, specifications, etc. }]
  status      RequestStatus     @default(CREATED)
  priority    RequestPriority   @default(MEDIUM)
  
  // Multi-tenant
  orgId       String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  // Request metadata
  createdBy   String
  creator     User @relation(fields: [createdBy], references: [id])
  
  // Approval & Payment
  approvedVendorId String?
  approvedQuoteId  String?
  
  // Workflow metadata
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Deadlines
  requestedBy DateTime?
  approvedAt  DateTime?
  completedAt DateTime?

  // Relations
  quotes      Quote[]
  payments    Payment[]
  auditLogs   AuditLog[]

  @@map("procurement_requests")
}

enum RequestStatus {
  CREATED
  QUOTES_REQUESTED
  QUOTES_RECEIVED
  UNDER_REVIEW
  APPROVED
  PAYMENT_PENDING
  PAID
  COMPLETED
  CANCELLED
}

enum RequestPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Quote {
  id           String   @id @default(cuid())
  
  // Multi-tenant
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  // Relations
  requestId    String
  request      ProcurementRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  vendorId     String
  vendor       Vendor @relation(fields: [vendorId], references: [id])
  
  // Quote details
  items        Json     // Itemized quote details
  totalAmount  Decimal  @db.Decimal(12, 2)
  currency     String   @default("USD")
  
  // Terms
  deliveryDays Int?
  validUntil   DateTime?
  terms        Json?    // Payment terms, conditions, etc.
  
  // Processing metadata
  source       QuoteSource @default(EMAIL)
  rawData      Json?    // Original email/document data
  confidence   Float?   // AI parsing confidence score
  
  // Status
  status       QuoteStatus @default(PENDING)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  payments     Payment[]

  @@map("quotes")
}

enum QuoteSource {
  EMAIL
  UPLOAD
  MANUAL
  API
}

enum QuoteStatus {
  PENDING
  REVIEWED
  APPROVED
  REJECTED
}

// ================================
// PAYMENT & AUDIT MODELS
// ================================

model Payment {
  id           String        @id @default(cuid())
  
  // Multi-tenant
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  // Relations
  requestId    String
  request      ProcurementRequest @relation(fields: [requestId], references: [id])
  
  quoteId      String
  quote        Quote @relation(fields: [quoteId], references: [id])
  
  // Payment details
  amount       Decimal @db.Decimal(12, 2)
  currency     String  @default("USD")
  status       PaymentStatus @default(PENDING)
  
  // Stripe integration
  stripePaymentIntentId String?
  stripeChargeId        String?
  
  // Payment metadata
  method       String? // card, bank_transfer, etc.
  metadata     Json?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  paidAt       DateTime?

  @@map("payments")
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
}

model AuditLog {
  id           String   @id @default(cuid())
  
  // Multi-tenant
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  // Audit details
  action       String   // CREATE, UPDATE, DELETE, APPROVE, etc.
  entityType   String   // ProcurementRequest, Quote, Payment, etc.
  entityId     String
  
  // User context
  userId       String?
  user         User? @relation(fields: [userId], references: [id])
  
  // Change details
  oldValues    Json?
  newValues    Json?
  metadata     Json?
  
  createdAt    DateTime @default(now())

  // Optional relation to procurement request
  requestId    String?
  request      ProcurementRequest? @relation(fields: [requestId], references: [id])

  @@map("audit_logs")
}

// ================================
// WORKFLOW & EMAIL MODELS
// ================================

model EmailThread {
  id           String   @id @default(cuid())
  
  // Multi-tenant
  orgId        String
  
  // Email details
  gmailThreadId String  @unique
  subject      String
  participants Json     // Array of email addresses
  
  // Relations
  requestId    String?
  
  // Metadata
  lastMessageAt DateTime
  messageCount  Int @default(0)
  metadata     Json?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  messages     EmailMessage[]

  @@map("email_threads")
}

model EmailMessage {
  id           String   @id @default(cuid())
  
  // Relations
  threadId     String
  thread       EmailThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  
  // Email details
  gmailMessageId String @unique
  sender        String @map("from")
  to           Json     // Array of recipients
  subject      String
  body         String   @db.Text
  
  // Processing
  isProcessed  Boolean @default(false)
  extractedData Json?  // Parsed quote data
  
  // Attachments
  attachments  Json?   // Array of attachment metadata
  
  createdAt    DateTime @default(now())
  receivedAt   DateTime

  @@map("email_messages")
}

// ================================
// WORKFLOW STATE MODELS
// ================================

model WorkflowExecution {
  id           String   @id @default(cuid())
  
  // Multi-tenant
  orgId        String
  
  // Workflow details
  workflowType String   // procurement_request, quote_processing, etc.
  entityId     String   // ID of the entity being processed
  entityType   String   // ProcurementRequest, Quote, etc.
  
  // LangGraph state
  currentState String
  stateData    Json
  
  // Execution metadata
  status       WorkflowStatus @default(RUNNING)
  startedAt    DateTime @default(now())
  completedAt  DateTime?
  errorMessage String?
  
  // Checkpoints for resumability
  checkpoints  Json?

  @@map("workflow_executions")
}

enum WorkflowStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

// ================================
// RLS POLICIES (Applied via SQL)
// ================================

// Note: RLS policies will be applied via SQL migrations
// Each table will have policies like:
// CREATE POLICY tenant_isolation ON table_name FOR ALL TO authenticated 
// USING (org_id = current_setting('app.current_tenant')::text);